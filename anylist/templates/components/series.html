{% extends "base.html" %}
{% block content %}
	<div>
	{% include "forms/add_serie.html" %}
	</div>
	<table class="series_list">
	{% for val in object_list %}
	{% for item in val.series %}
		<tr>
			<td class="num_ser" id="num-{{ item.number }}">{{ item.number }}</td>
			<td class="name_ser" id="name-{{ item.number }}">{{ item.name }}</td>
			<td class="pub_ser" id="pub_ser-{{ item.number }}">{{ item.start_date }}</td>
			<td class="len_ser" id="len_ser-{{ item.number }}">{{ item.length }}</td>
			<td><img src="/static/edit.png" style="float:right" class="edit-ser" id="{{ item.number }}-edit"></td>
			<td><button class="add_one_ser" id="add_ser-{{ item.number }}-{{ val.number }}">Просмотреть</button></td>
		</tr>
	{% endfor %}
	{% endfor %}
	</table>
{% endblock %}
{% block script %}
	{{ block.super }}
	<script type="text/javascript">
		infoBlockModule.renderLeftMenu("nav");
		
		var link = document.location.pathname.split("/")[2].split("-")[0];
		var category = document.location.pathname.split("/")[1];
		$("#pub_d").datetimepicker();
		// показывает формочку добавления новой серии
		// P.S переделать с использованием анимаций
		$("#add_serie").click(function () {
			if ($(".add_serie_form").css("display") == "none")
				$(".add_serie_form").show();
			else
				$(".add_serie_form").hide();
		});
		// отправляет данные формы
		$("#add_serie_form").submit(function () {
			$.post(
				"/" + category + "/series/add",
				$("#add_serie_form").serialize() + "&product=" + link
				//$("#add_serie_form").serialize() + "&"{{ category.get_absolute_url }}"=" + link
			);
			return false;
		});
		var old_num, old_name, old_pub_date, old_len, ident, is_delta = false;
		$(".edit-ser").click(function(element) {
			var id = element.target.id.split("-")[0];
			if ($("#" + element.target.id).attr("src") == "/static/check.png") {
				// сохранение данных, если они изменились
				// вместо old_name указать другой способ, т.к. непонятно, что делать
				// если мы изменим данные (как вариант - на каждый ввод - пересохранять
				// новое значение в переменной new_<xxx>)
				$("#num-" + id).html(old_num);
				$("#name-" + id).html(old_name);
				$("#pub_ser-" + id).html(old_pub_date);
				$("#len_ser-" + id).html(old_len);

				if (is_delta && ident != -1) {
					$.ajax({
						url: "/" + category + "/series/edit",
						data: {
							number: old_num,
							name: old_name,
							start_date: old_pub_date,
							length: old_len,
							ident: ident,
							product: link
						},
						type: "POST",
					});
					is_delta = false;
					ident = -1;
				}
				old_num = null;
				$("#" + element.target.id).attr("src", "/static/edit.png")
			}
			// редактирование возможно только с одним элемнтом одновременно
			else if (!old_num) {
				old_num = $("#num-" + id).html();
				ident = old_num;		// запоминаем номер исправляемой серии серии
				old_name = $("#name-" + id).html();
				old_pub_date = $("#pub_ser-" + id).html();
				old_len = $("#len_ser-" + id).html();

				$("#num-" + id).html("<input style='width:2em' value='" + old_num + "''>");
				$("#name-" + id).html("<input value='" + old_name + "'>");
				$("#pub_ser-" + id).html("<input id='new_time' value='" + old_pub_date + "'>");
				$("#new_time").datetimepicker();
				$("#len_ser-" + id).html("<input value='" + old_len + "'>");
				// отрисовка поля ввода новых данных
				$("#" + element.target.id).attr("src", "/static/check.png");
			}
		});
		// сохранияем изменения форм серий
		$(".num_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_num != tmp) {
				old_num = tmp;
				is_delta = true;
			}
		});
		$(".name_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_name != tmp) {
				old_name = tmp;
				is_delta = true;
			}
		});
		$(".pub_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_pub_date != tmp) {
				old_pub_date = tmp;
				is_delta = true;
			}
		});
		$(".len_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_len != tmp) {
				old_len = tmp;
				is_delta = true;
			}
		});
		
		$(".add_one_ser").click(function (eventObject) {
			var id_serie = eventObject.target.id;
			var num_ser = id_serie.split("-")[1];
			var num_season = id_serie.split("-")[2];
			$.ajax({
				url: "/mylist/series/add",
				data: {
					number: num_ser,
					product: link,
					season: num_season
				},
				type: "POST"
			});
			//console.log("Серия: " + num_ser + " Сезон: " + num_season);
		});
	</script>
{% endblock %}