{% extends "base.html" %}
{% block content %}
	{% load wysiwyg %}
	{% wysiwyg_setup %}
	<div class="lightbox-genre">
		<div id="stanard_genres">
		<ul>
		{% for genre in standart_genres.genres %}
			<li>
				<input type="checkbox" id="{{ genre }}" class="genre_check">
				<label for="{{ genre }}">{{ genre.name }}</label>
			</li>
		{% endfor %}
		</ul>
		</div>
		<div id="other_genres">
		{% for group in genre_group %}
			<ul>
			{% for genre in group.genres %}
				<li>
				<input type="checkbox" id="{{ genre }}" class="genre_check">
				<label for="{{ genre }}">{{ genre.name }}</label>
				</li>
			{% endfor %}
			</ul><br>
		{% endfor %}
		</div>
		<button id="close_lightbox">Close</button>
	</div>
	<form enctype="multipart/form-data" method="post" id="add_form">
			<input name="title" type="text" placeholder="Enter title here" class="form-title">
			<ul class="dropdown-title"></ul>
			<textarea class="form-textarea" rows="15" name="description" id="description"></textarea>
			<div id="upload_form">
				<input type="file" name="avatar">
			</div>
		<div class="form-other">
			<select name="genres" id="genres" style="width:10em;" multiple>
				{% for genre in genres %}
				<option value="{{ genre.id }}">{{ genre.name }}</option>
				{% endfor %}
			</select>
			<p></p>
			<!--<button id="sel_genres">Выберите жанры</button>-->
			<select name="old_limit" style="width:10em">
			{% for item in raiting %}
				<option value="{{ item.id }}">{{ item }}</option>
			{% endfor %}
			</select>
			<!--<input type="text" class="select-list" placeholder="Введите возрастное ограничение" name="old_limit">-->
		</div>
		<div>
			{% csrf_token %}
			<button type="submit">Next Step</button>
		</div>
	</form>
	{% wysiwyg_editor "description" %}
{% endblock %}
{% block script %}
<script type="text/javascript">
	var genres = [];
	$(".lightbox-genre").hide();
	$("#sel_genres").click(function (eventObject) {
		$(".lightbox-genre").show();
		eventObject.preventDefault();
	});
	$("#close_lightbox").click(function () {
		$(".lightbox-genre").hide();
	});
	$("#datetimepick1").datetimepicker({
		timepicker: false,
		format: 'd/m/Y'
	});
	$("#genres").select2({
		width: 400,
		placeholder: "Выберите жанры"
	});
	$("select[name='old_limit']").select2({
		width: 100
	});

	/* --------------------------------------
	// отправка данных формы
	*///-------------------------------------
	$("#add_form").submit({genres: genres}, function (eventObject) {
		// указываем, куда отсылать запрос
		var link = window.location.pathname.split("/")[1];
		$("#add_form").attr("action", "/" + link + "/add");
		//console.log(eventObject);
		//return false;
	});
	// добавляем id жанра в коллекцию, если установлен соответсвующий флажок
	$(".genre_check").click(function (eventObject) {
		var box = eventObject.currentTarget;
		if (box.checked)
			genres.push(box.id.split("-")[0]);
		else
			genres = genres.filter(function(elem) {
				return elem != box.id.split("-")[0];
			});
	});

	$("input[name='title']").keypress(function (eventObject) {
		if (!eventObject.ctrlKey && eventObject.key.length < 2 && !eventObject.shiftKey) {
			$.get(
				"/search",
				{ key:  eventObject.target.value + eventObject.key},
				function (data) {
					console.log(data);
					$(".dropdown-title").html("");
					for (var key in data) {
						$(".dropdown-title").append("<li><a href='" + data[key] + "'>" + key + "</a></li><br>");
					}
				}
			);
		}
	});
</script>
{% endblock %}