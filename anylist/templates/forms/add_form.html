{% extends "base.html" %}
{% block head %}
<link rel="stylesheet" href="/static/select2/select2.css">
<script src="/static/jquery.min.js"></script>
<script src="/static/select2/select2.js"></script>
{% endblock %}
{% block header %}{{ header }}{% endblock %}
{% block title %}{{ header }}{% endblock %}
{% block body %}
<main ng-controller="AddCtrl">
	{% load wysiwyg %}
	{% wysiwyg_setup %}
	<form enctype="multipart/form-data" method="post" id="add_form" action="/{{ category }}/add">
			<input name="title" type="text" placeholder="Enter title here" class="form-title">
			<ul class="dropdown-title"></ul>
			<textarea class="form-textarea" rows="15" name="description" id="description"></textarea>
			<div id="upload_form">
				<input type="file" name="avatar" id="file">
			</div>
		<div class="form-other">
			<div id="select_genre_fon" ng-click="hide_lightbox">
				<div id="select_genre"><ul>
					<li ng-repeat="genre in genres">
						<input type="checkbox" id="{[{genre.id}]}" ng-model="genres" ng-true-value="{[{genre.id}]}" ng-click="add(genre.id, this)">
						<label for="{[{genre.id}]}">{[{genre.name}]}</label>
					</li>
				</ul>
				<button ng-click="add()">Close</button>
				<button>Clear</button>
				</div>
			</div>
			<!--<select name="genres" id="genres" style="width:10em;" multiple>
				{% for genre in genres %}
				<option value="{{ genre.id }}">{{ genre.name }}</option>
				{% endfor %}
			</select>
			<p></p>-->
			<!--<button id="sel_genres">Выберите жанры</button>-->
			<!--<select name="old_limit" style="width:10em">
			{% for item in raiting %}
				<option value="{{ item.id }}">{{ item }}</option>
			{% endfor %}
			</select>-->
			<select>
				<option>--> Select Old Limit</option>
				<option ng-repeat="limit in raiting" value="{[{limit.value}]}">{[{limit.key}]}</option>
			</select>
			<!--<input type="text" class="select-list" placeholder="Введите возрастное ограничение" name="old_limit">-->
		</div>
		<div>
			{% csrf_token %}
			<button type="submit">Next Step</button>
		</div>
	</form>
	{% wysiwyg_editor "description" %}
</main>
{% endblock %}
{% block script %}
<script type="text/javascript">
	$("#genres").select2({
		width: 400,
		placeholder: "Выберите жанры"
	});
	/*$("select[name='old_limit']").select2({
		width: 100
	});
*/
	/* --------------------------------------
	// отправка данных формы
	*///-------------------------------------
	/*$("#add_form").submit({genres: genres}, function (eventObject) {
		// указываем, куда отсылать запрос
		var link = window.location.pathname.split("/")[1];
		$("#add_form").attr("action", "/" + link + "/add");
	});*/
	// добавляем id жанра в коллекцию, если установлен соответсвующий флажок
	$(".genre_check").click(function (eventObject) {
		var box = eventObject.currentTarget;
		if (box.checked)
			genres.push(box.id.split("-")[0]);
		else
			genres = genres.filter(function(elem) {
				return elem != box.id.split("-")[0];
			});
	});

	$("input[name='title']").keypress(function (eventObject) {
		if (!eventObject.ctrlKey && eventObject.key.length < 2 && !eventObject.shiftKey) {
			$.get(
				"/search",
				{ key:  eventObject.target.value + eventObject.key},
				function (data) {
					$(".dropdown-title").html("");
					for (var key in data) {
						$(".dropdown-title").append("<li><a href='" + data[key] + "'>" + key + "</a></li><br>");
					}
				}
			);
		}
	});
	defaultApp.controller('AddCtrl', ['$scope', '$http', '$location', function ($scope, $http, $location) {
		$scope.raiting = [{'key': 'G', 'value': '0'}, {'key': 'PG', 'value': '1'}, {'key': 'PG-13', 'value': '2'},
			{'key': 'R', 'value': '3'}, {'key': 'NC-17', 'value': '4'}];
		/*$scope.hide_lightbox = function () {
			var d = document.getElementById('select_genre');
			d.style.visibility = 'hidden';
			var e = document.getElementById('select_genre_fon');
			e.style.visibility = 'hidden';
		}*/
		$http.get('/api/genres').success(function (data) {
			$scope.genres = data;
			$scope.genre_model = {};
		});
		$scope.selected_genres = [];
		$scope.add = function (item, elem) {
			if ($scope.selected_genres.indexOf(item) == -1) {
				$scope.selected_genres.push(item);
			} else {
				$scope.selected_genres = $scope.selected_genres.filter(function (elem) {
					return elem != item;
				});
			}
		}
	}]);
</script>
{% endblock %}