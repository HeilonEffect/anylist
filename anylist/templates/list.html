{% extends "base.html" %}
{% block title %}{{ header }}{% endblock %}
{% block header %}{{ header }}{% endblock %}
{% block body %}
<main ng-controller="ListCtrl">
	<img src="/static/img/add.svg" class="add_form" ng-click="add_form()">
	<img src="/static/img/expand.png" class="expand" ng-click="show_panel()">
	<ul>
		<li ng-repeat="product in products">
			<a href="{[{product.url}]}">
				<figure>
					<img src="{[{product.avatar_path}]}">
					<figcaption>{[{product.title}]}</figcaption>
				</figure>
			</a>
		</li>
	</ul>
	<nav ng-show="panel_visibility">
		<p>Raiting</p>
		<div ng-repeat="old_limit in raiting">
			<input type="checkbox" id="{[{old_limit.name}]}" ng-model="old_limit.checked" ng-change="start_filter(this)">
			<label for="{[{old_limit.name}]}">{[{old_limit.name}]}</label>
		</div>
		<p>Genres</p>
		<p ng-repeat-start="group in genre_groups">
			<div ng-repeat="genre in group.genres">
				<input type="checkbox" id="{[{genre}]}" ng-model="genre.checked" ng-change="start_filter(this)">
				<label for="{[{genre}]}">{[{genre.name}]}</label>
			</div>
		</p>
		<div ng-repeat-end></div>
	</nav>
</main>
{% endblock %}
{% block script %}
<script>
	defaultApp.controller('ListCtrl', ['$scope', '$http', '$location',
			function ($scope, $http, $location) {
				$scope.panel_visibility = false;
				$scope.active_genres = {};
				$scope.active_limits = {};

				var limits = $location.absUrl().split('/').slice(5);
				var lims = [];
				var genres = [];
				
				if (limits.indexOf('old_limit') != -1)
					lims = limits[limits.indexOf('old_limit') + 1].split(',');
				if (limits.indexOf('genres') != -1)
					genres = limits[limits.indexOf('genres') + 1].split(',');
				
				for (var i in lims)
					$scope.active_limits[lims[i]] = true;
				for (var i in genres)
					$scope.active_genres[genres[i]] = true;

				var category = $location.absUrl().split('/');
				category = category[3];

				$http.get('/api/genres/category:' + category).success(function (data) {
					$scope.genre_groups = data;
					for (var i in data)
						for (var j in data[i].genres) {
							if (genres.indexOf(data[i].genres[j].name) != -1)
								$scope.genre_groups[i].genres[j].checked = true;
							else
								$scope.genre_groups[i].genres[j].checked = false;
						}
				});

				$http.get('/api/raitings').success(function (data) {
					$scope.raiting = data;
					for (var i in data) {
						if (lims.indexOf(data[i].name) != -1)
							$scope.raiting[i].checked = true;
						else
							$scope.raiting[i].checked = false;
					}
				});

				$scope.start_filter = function (elem) {
					// По нажатию на флажок - фиксируем активный элемент
					if (elem.genre)
						$scope.active_genres[elem.genre.name] = !$scope.active_genres[elem.genre.name];

					if (elem.old_limit)
						$scope.active_limits[elem.old_limit.name] = !$scope.active_limits[elem.old_limit.name];
					var next_url = '/filter';

					// Удаляем элемнты, равные false
					var tmp = Object.keys($scope.active_limits).filter(function (elem) {
						return $scope.active_limits[elem];
					});
					// Если елемнты ещё остались - заносим их в схему url'a
					if (tmp.length > 0) {
						next_url += '/old_limit/';
						for (var i in tmp)
							next_url += tmp[i] + ',';
						next_url = next_url.slice(0, next_url.length - 1);
					}
					tmp = Object.keys($scope.active_genres).filter(function (elem) {
						return $scope.active_genres[elem];
					});
					if (tmp.length > 0) {
						next_url += '/genres/';
						for (var i in tmp)
							next_url += tmp[i] + ',';
						next_url = next_url.slice(0, next_url.length - 1);
					}
					if (next_url == '/filter')
						next_url = '';
					window.location.href = $location.absUrl().split('/').slice(0, 4).join('/') + next_url + '/';
				}

				var url = $location.absUrl().split('/').slice(3).join('/');

				$http.get('/api/products/category:' + url).success(function (data) {
					$scope.products = data;
				});

				$scope.show_panel = function () {
					$scope.panel_visibility = !$scope.panel_visibility;
				}

				$scope.add_form = function () {
					window.location.href = $location.absUrl().split('/').slice(0, 4).join('/') + "/add";
				}
			}
		]);
</script>
{% endblock %}