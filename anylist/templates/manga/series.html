{% extends "base.html" %}
{% block content %}
<button id="new_vol">Новый том</button>
	{% for val in object_list %}
	<table class="series_list">
		
		<p>Volume {{ val.number }}&nbsp;&nbsp;&nbsp;<sub><img src="/static/add.png" class="add_serie" style="width:2em;" id="add-{{ val.number }}"></sub></p>
		<div style="width:70%">
			<form method="post" class="add_serie_form" id="{{ val.number }}">
				<input name="number" type="text" placeholder="Номер" style="width:3em">
				<input name="name" type="text" placeholder="Название">
				<input name="start_date" type="datetime" placeholder="Дата" class="pub_d" style="width:8em">
				<input name="length" type="text" placeholder="Число страниц">
				<input type="submit" value="Add" class="submit_serie">
			</form>
		</div>
		
		{% for item in val.series %}
		<tr>
			<td class="num_ser" id="num-{{ item.number }}-{{ val.number }}">{{ item.number }}</td>
			<td class="name_ser" id="name-{{ item.number }}-{{ val.number }}" style="min-width:9em">{{ item.name }}</td>
			<td class="pub_ser" id="pub_ser-{{ item.number }}-{{ val.number }}">{{ item.start_date }}</td>
			<td class="len_ser" id="len_ser-{{ item.number }}-{{ val.number }}">{{ item.length }}</td>
			<td><img src="/static/edit.png" style="float:right" class="edit-ser" id="{{ item.number }}-{{ val.number}}-edit"></td>
			{% if item.id in numbers %}
			<td><button class="del_one_ser" id="del_ser-{{ item.number }}-{{ val.number }}">Удалить из просмотренных</button></td>
			{% else %}
			<td><button class="add_one_ser" id="add_ser-{{ item.number }}-{{ val.number }}">Просмотреть</button></td>
			{% endif %}
		</tr>
		{% endfor %}
	</table>
	{% endfor %}
{% endblock %}

{% block script %}
	{{ block.super }}
	<script type="text/javascript">
		infoBlockModule.renderLeftMenu("nav");
		
		// link - id продукта
		var link = document.location.pathname.split("/")[2].split("-")[0];
		
		var category = document.location.pathname.split("/")[1];
		$("#new_vol").click(function () {
			$.ajax({
				url: "/manga/volume/add",
				data: {
					product: link
				},
				type: "POST"
			});
		});
		/*$(".add_serie").click(function () {
			if ($(".add_serie_form").css("display") == "none")
				$(".add_serie_form").show();
			else
				$(".add_serie_form").hide();
		});*/
		$(".add_serie_form").submit(function (eventObject) {
			var num_season = eventObject.target.id;
			var data = $("#" + num_season).serialize();
			console.log(data + "&product=" + link + "&season=" + num_season);
			$.post(
				"/manga/series/add",
				data + "&product=" + link + "&season=" + num_season
			);
			return false;
		});
		$(".pub_d").datetimepicker();
		$(".add_one_ser").click(function (eventObject) {
			var id_serie = eventObject.target.id;
			var num_ser = id_serie.split("-")[1];
			var num_season = id_serie.split("-")[2];
			$.ajax({
				url: "/mylist/series/add",
				data: {
					number: num_ser,
					product: link,
					season: num_season
				},
				type: "POST"
			});
			//console.log("Серия: " + num_ser + " Сезон: " + num_season);
		});

		$(".del_one_ser").click(function (eventObject) {
			var id_serie = eventObject.target.id;
			var num_ser = id_serie.split("-")[1];
			var num_season = id_serie.split("-")[2];
			$.ajax({
				url: "/mylist/series/del",
				data: {
					number: num_ser,
					product: link,
					season: num_season
				},
				type: "POST"
			});
		});

		var old_num, old_name, old_pub_date, old_len, ident, is_delta = false;
		$(".edit-ser").click(function(element) {
			var id = element.target.id.split("-")[0];
			var season = element.target.id.split("-")[1];
			console.log(season);
			if ($("#" + element.target.id).attr("src") == "/static/check.png") {
				// сохранение данных, если они изменились
				// вместо old_name указать другой способ, т.к. непонятно, что делать
				// если мы изменим данные (как вариант - на каждый ввод - пересохранять
				// новое значение в переменной new_<xxx>)
				$("#num-" + id + "-" + season).html(old_num);
				$("#name-" + id + "-" + season).html(old_name);
				$("#pub_ser-" + id + "-" + season).html(old_pub_date);
				$("#len_ser-" + id + "-" + season).html(old_len);


				if (is_delta && ident != -1) {
					$.ajax({
						url: "/" + category + "/series/edit",
						data: {
							number: old_num,
							name: old_name,
							start_date: old_pub_date,
							length: old_len,
							ident: ident,
							product: link,
							season: element.target.id.split("-")[1]
						},
						type: "POST",
					});
					is_delta = false;
					ident = -1;
				}
				old_num = null;
				$("#" + element.target.id).attr("src", "/static/edit.png")
			}
			// редактирование возможно только с одним элемнтом одновременно
			else if (!old_num) {
				old_num = $("#num-" + id + "-" + season).html();
				ident = old_num;		// запоминаем номер исправляемой серии серии
				old_name = $("#name-" + id + "-" + season).html();
				old_pub_date = $("#pub_ser-" + id + "-" + season).html();
				old_len = $("#len_ser-" + id + "-" + season).html();

				$("#num-" + id + "-" + season).html("<input style='width:2em' value='" + old_num + "''>");
				$("#name-" + id + "-" + season).html("<input value='" + old_name + "'>");
				$("#pub_ser-" + id + "-" + season).html("<input id='new_time' value='" + old_pub_date + "'>");
				$("#new_time").datetimepicker();
				$("#len_ser-" + id + "-" + season).html("<input value='" + old_len + "'>");
				// отрисовка поля ввода новых данных
				$("#" + element.target.id).attr("src", "/static/check.png");
			}
		});
		// сохранияем изменения форм серий
		$(".num_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_num != tmp) {
				old_num = tmp;
				is_delta = true;
			}
		});
		$(".name_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_name != tmp) {
				old_name = tmp;
				is_delta = true;
			}
		});
		$(".pub_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_pub_date != tmp) {
				old_pub_date = tmp;
				is_delta = true;
			}
		});
		$(".len_ser").change(function (eventObject) {
			var tmp = eventObject.target.value;
			if (old_len != tmp) {
				old_len = tmp;
				is_delta = true;
			}
		});
	</script>
{% endblock %}