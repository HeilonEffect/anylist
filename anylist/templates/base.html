<!doctype html>
<html lang="ru" ng-app="defaultApp">
<head>
	<meta charset="utf-8">
	<title>{% block title %}Base title{% endblock %}</title>
	<script src="/static/lib/angular.min.js"></script>
	<!--<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>-->
	<script src="/static/lib/angular-cookies.min.js"></script>
	<script src="/static/lib/angular-file-upload.min.js"></script>
	<!--<script src="/static/datetimepicker_css.js"></script>-->
	<!-- <link rel="stylesheet" href="/static/series/style.css"> -->
	<link rel="stylesheet" href="/static/css/header.css">
	<link rel="stylesheet" href="/static/css/main_page.css">
	<link rel="stylesheet" href="/static/css/list.css">
	<link rel="stylesheet" type="text/css" href="/static/css/forms.css">
	{% block head %}{% endblock %}
</head>
<body ng-controller="DefaultCtrl">
	<header>
		<menu>
			<div class="search_block">
				<img src="/static/img/search.jpg">
				<input type="search" placeholder="Search" ng-change="searcher()" ng-model="search_data">
				<nav>
					<p ng-repeat="item in search_result"><a href="{[{item.link}]}">{[{item.name}]}</a></p>
				</nav>
			</div>
			{% if user.is_authenticated %}
				<a href="/profile">{{ user.username }}</a>
				<button ng-click="logout()">Log Out</button>
			{% else %}
				<button ng-click="login()">Log In</button>
			{% endif %}
		</menu>
		<img src="/static/img/show_main_menu.png" ng-click="show_menu()">
		<h1>{% block header %}Header{% endblock %}</h1>
			<form ng-submit="auth_me()" ng-show="visibility_form" ng-click="login()">
				<div ng-click="login()">
					<input ng-model="auth.username" placeholder="Username" type="text"><br>
					<input ng-model="auth.password" placeholder="Password" type="password"><br>
					<input ng-model="auth.is_reg"  type="checkbox" id="auth_check">
					<label for="auth_check">Register Me</label>
					<input type="submit" value="Auth">
				</div>
			</form>
	</header>
	<details ng-show="hidden_menu">
		<nav>
		<ul ng-repeat="group in category_group">
			<li ng-repeat="category in group.categories">
				<a href="{[{category.url}]}">
					<figure>
						<img src="{[{category.icon}]}">
						<figcaption>{[{category.name}]}</figcaption>
					</figure>
				</a>
			</li>
		</ul>
		</nav>
		<div ng-click="show_menu()"></div>
	</details>
	{% block body %}
	{% endblock %}
	<script>
		var defaultApp = angular.module('defaultApp', [
			'angularFileUpload', 'ngCookies'
		]).run(function ($http, $cookies) {
			$http.defaults.headers.post['X-CSRFToken'] = '{{ csrf_token }}';
		});

		defaultApp.config(function ($interpolateProvider) {
			$interpolateProvider.startSymbol('{[{');
			$interpolateProvider.endSymbol('}]}');
		});

		defaultApp.controller('DefaultCtrl', ['$scope', '$http', '$location',
			function ($scope, $http, $location) {
				$scope.hidden_menu = false;
				$scope.visibility_form = false;
				
				$scope.show_menu = function () {
					$scope.hidden_menu = !$scope.hidden_menu;
				}

				$http.get('/api/categories/?format=json').success(function (data) {
					$scope.category_group = data;
				});

				$scope.auth_me = function () {
					var url = $location.absUrl()
					if ($scope.auth['is_reg'])
						url += 'register/';
					else
						url += 'login/';
					var data = '';
					for (var key in $scope.auth)
						data += ("&" + key + '=' + $scope.auth[key]);
					data = data.replace('undefined', '').slice(1);
					$http({
						method: "POST",
						url: url,
						data: data,
						headers: {
							"Content-Type": "application/x-www-form-urlencoded"
						}
					}).success(function (data) {
						window.location.href = window.location.href;
					});
				}

				$scope.logout = function () {
					window.location.pathname += "logout";
				}

				$scope.login = function () {
					$scope.visibility_form = !$scope.visibility_form;
				}
				$scope.searcher = function () {
					$http.get('/search?key=' + $scope.search_data).success(function (data) {
						$scope.search_result = data;
					});
				}
			}
		]);
	</script>
	{% block script %}
	{% endblock %}
</body>
</html>